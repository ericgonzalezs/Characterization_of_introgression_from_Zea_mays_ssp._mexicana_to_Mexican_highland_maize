#PBS -N SNP_filter
#PBS -l nodes=1:ppn=8,vmem=30gb,walltime=250:00:00
#PBS -q default
#PBS -V

cd $PBS_O_WORKDIR

NP=$(wc -l < $PBS_NODEFILE)

module load bcftools/1.3.1
module load tabix/0.2.6


#index for the vcf file containing the SNPs of the PTs and 1261
tabix -p vcf 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10.vcf.gz

#file wthe CML457 sites
grep -v "#" CML457.vcf | awk -F "\t" -v OFS="\t" '{print $1, $2}' > sitios_457_para_filtrar.txt

#filtering the PTs-1261 file with CML457 sites
bcftools filter -R sitios_457_para_filtrar.txt --threads 8 -Oz 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10.vcf.gz > 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10_sitios_457.vcf.gz

#file with the PTs-1261 sites that macth CML457 sites
zcat 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10_sitios_457.vcf.gz | grep -v "#" | awk -F "\t" -v OFS="\t" '{print $1, $2}' > sitios_PTs_1261_para_filtrar.txt

#Preparing CML457 vcf file for filtering
bgzip -c CML457.vcf > CML457.vcf.gz
tabix -p vcf CML457.vcf.gz

#Filtering CML457 vcf file
bcftools filter -R sitios_PTs_1261_para_filtrar.txt --threads 8 -Oz CML457.vcf.gz > CML457_sitios_PTs_1261.vcf.gz

#Then I tried to merge the filtered VCF files but dosen't work because the vcf CML457 file have the CML SNPs such as the "Reference alleles" so, they differ form the B73 alleles
#whta I tried was the next steps but th emerging faill

#preparing for merge

tabix -p vcf 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10_sitios_457.vcf.gz
tabix -p vcf CML457_sitios_PTs_1261.vcf.gz

#merging
bcftools merge -Oz 1261_PTs_MQ30_BQ20_SNPs_filtered_GQ20_DP10_sitios_457.vcf.gz CML457_sitios_PTs_1261.vcf.gz  > 1261_PTs_457.vcf.gz

#Because this last steps dosen't work, I convert the filtered vcf files to hapmap format and I used Tassel to merge and keep the variant sites for inv4m.

#I made the hapmap format with the filtered vcf files instead the original biger files in order to allow my small computer to read them more easily uing tassel

#repet√≠ lo mismo para el archivo filtrado tomando en cuenta todas las CMLs con 362013 sitios usando el archivo CML457_362013_sitios.vcf
